apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${CI_PROJECT_PATH_SLUG}
  annotations:
    app.gitlab.com/app: ${CI_PROJECT_PATH_SLUG}
    app.gitlab.com/env: ${CI_ENVIRONMENT_SLUG}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${CI_PROJECT_PATH_SLUG}
  template:
    metadata:
      labels:
        app: ${CI_PROJECT_PATH_SLUG}
        version: "${CI_COMMIT_SHORT_SHA}"
      annotations:
        app.gitlab.com/app: ${CI_PROJECT_PATH_SLUG}
        app.gitlab.com/env: ${CI_ENVIRONMENT_SLUG}
    spec:
      containers:
        - name: ${CI_PROJECT_PATH_SLUG}-nginx
          image: ${CI_REGISTRY_IMAGE}/nginx:${CI_ENVIRONMENT_SLUG}
          imagePullPolicy: Always
          securityContext:
            capabilities:
              add: ["SETUID", "SETGID", "DAC_OVERRIDE", "CHOWN"]
        - name: ${CI_PROJECT_PATH_SLUG}-fpm
          image: ${CI_REGISTRY_IMAGE}/fpm:${CI_ENVIRONMENT_SLUG}
          imagePullPolicy: Always
          securityContext:
            capabilities:
              add: ["SETUID", "SETGID"]
          volumeMounts:
            - name: configs
              mountPath: /srv/http/nox/.env
              subPath: .env
#        - name: ${CI_PROJECT_PATH_SLUG}-mariadb
#          image: ${CI_REGISTRY_IMAGE}/mariadb:${CI_ENVIRONMENT_SLUG}
#          imagePullPolicy: Always
#          securityContext:
#            capabilities:
#              add: ["SETUID", "SETGID"]
#          volumeMounts:
#            - name: data
#              mountPath: /var/lib/mysql
      volumes:
        - name: configs
          configMap:
            name: ${CI_PROJECT_PATH_SLUG}-configs
        - name: data
          cephfs:
            monitors:
              - 10.0.3.1:6789
            path: /volumes/_nogroup/nox/b1ba748f-bf53-4d53-8e41-4acc6621dc10
            user: nox
            secretRef:
              name: ${CI_PROJECT_PATH_SLUG}-ceph
---
apiVersion: v1
kind: Service
metadata:
  name: ${CI_PROJECT_PATH_SLUG}
spec:
  selector:
    app: ${CI_PROJECT_PATH_SLUG}
  ports:
    - name: nox-http
      protocol: TCP
      port: 80
    - name: nox-mariadb
      protocol: TCP
      port: 3306
  clusterIP: 10.96.1.4
